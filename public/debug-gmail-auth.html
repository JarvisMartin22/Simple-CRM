<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Gmail Auth</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .log-entry {
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .timestamp {
            color: #666;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Gmail Authentication Debugger</h1>
    
    <div class="container">
        <h2>1. Environment Check</h2>
        <div id="env-status" class="status info">Checking environment...</div>
    </div>
    
    <div class="container">
        <h2>2. Authentication Status</h2>
        <div id="auth-status" class="status info">Checking authentication...</div>
        <button id="refresh-session" disabled>Refresh Session</button>
        <button id="login" disabled>Login</button>
    </div>
    
    <div class="container">
        <h2>3. Test Gmail Auth Function</h2>
        <button id="test-function" disabled>Test Gmail Auth Function</button>
        <div id="function-result" class="hidden">
            <h3>Function Response:</h3>
            <pre id="function-response"></pre>
        </div>
    </div>
    
    <div class="container">
        <h2>4. Debug Log</h2>
        <button id="clear-log">Clear Log</button>
        <div id="debug-log"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            entry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logDiv.appendChild(entry);
        };

        const updateStatus = (elementId, message, type) => {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        };

        // Initialize Supabase client
        const supabaseUrl = 'https://bujaaqjxrvntcneoarkj.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1amFhcWp4cnZudGNuZW9hcmtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NTQwNzQsImV4cCI6MjA2MjEzMDA3NH0.cX-07WwAXeutGV1_lahlsloiu_KIPIy8SQXmHfrGKXw';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        // Step 1: Check environment
        updateStatus('env-status', 'Environment configured: Supabase URL and Anon Key present', 'success');
        log('Supabase client initialized', 'success');
        
        // Step 2: Check authentication
        async function checkAuth() {
            try {
                log('Checking authentication status...');
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    updateStatus('auth-status', `Error getting session: ${error.message}`, 'error');
                    log(`Auth error: ${error.message}`, 'error');
                    document.getElementById('login').disabled = false;
                    return null;
                }
                
                if (!session) {
                    updateStatus('auth-status', 'Not authenticated. Please login first.', 'error');
                    log('No active session found', 'error');
                    document.getElementById('login').disabled = false;
                    return null;
                }
                
                const { data: { user } } = await supabase.auth.getUser();
                updateStatus('auth-status', `Authenticated as: ${user.email}`, 'success');
                log(`User authenticated: ${user.email} (ID: ${user.id})`, 'success');
                log(`Access token: ${session.access_token.substring(0, 20)}...`, 'info');
                log(`Token expires at: ${new Date(session.expires_at * 1000).toLocaleString()}`, 'info');
                
                document.getElementById('refresh-session').disabled = false;
                document.getElementById('test-function').disabled = false;
                
                return session;
            } catch (err) {
                updateStatus('auth-status', `Unexpected error: ${err.message}`, 'error');
                log(`Unexpected error: ${err.message}`, 'error');
                return null;
            }
        }
        
        // Test function button
        document.getElementById('test-function').addEventListener('click', async () => {
            log('Testing gmail-auth function...');
            document.getElementById('function-result').classList.remove('hidden');
            document.getElementById('function-response').textContent = 'Loading...';
            
            try {
                // Get current session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error('No active session');
                }
                
                log(`Using access token: ${session.access_token.substring(0, 20)}...`);
                
                // Test the function with explicit headers
                const response = await supabase.functions.invoke('gmail-auth', {
                    body: { test: true },
                    headers: {
                        Authorization: `Bearer ${session.access_token}`
                    }
                });
                
                log(`Function response received: ${response.error ? 'Error' : 'Success'}`);
                
                if (response.error) {
                    // Try to parse the error details
                    let errorDetails = response.error.message;
                    try {
                        if (response.error.context && response.error.context.body) {
                            const errorBody = JSON.parse(response.error.context.body);
                            errorDetails = JSON.stringify(errorBody, null, 2);
                        }
                    } catch (e) {
                        // Use original error message
                    }
                    
                    document.getElementById('function-response').textContent = 
                        `Error: ${response.error.message}\n\nDetails:\n${errorDetails}`;
                    log(`Function error: ${response.error.message}`, 'error');
                } else {
                    document.getElementById('function-response').textContent = 
                        JSON.stringify(response.data, null, 2);
                    log('Function executed successfully!', 'success');
                    
                    if (response.data.url) {
                        log(`Auth URL generated: ${response.data.url.substring(0, 50)}...`, 'success');
                    }
                }
            } catch (err) {
                document.getElementById('function-response').textContent = 
                    `Exception: ${err.message}\n\n${err.stack}`;
                log(`Exception: ${err.message}`, 'error');
            }
        });
        
        // Refresh session button
        document.getElementById('refresh-session').addEventListener('click', async () => {
            log('Refreshing session...');
            try {
                const { data, error } = await supabase.auth.refreshSession();
                if (error) {
                    log(`Failed to refresh session: ${error.message}`, 'error');
                } else {
                    log('Session refreshed successfully', 'success');
                    await checkAuth();
                }
            } catch (err) {
                log(`Error refreshing session: ${err.message}`, 'error');
            }
        });
        
        // Login button
        document.getElementById('login').addEventListener('click', () => {
            log('Redirecting to login page...');
            window.location.href = '/login';
        });
        
        // Clear log button
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('debug-log').innerHTML = '';
            log('Log cleared');
        });
        
        // Initial auth check
        checkAuth();
    </script>
</body>
</html>