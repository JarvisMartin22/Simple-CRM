<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Debug Link Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Link Click Tracking Debug</h1>
    
    <div id="status">Loading...</div>
    
    <h2>Test Links</h2>
    <div id="test-links"></div>
    
    <h2>Click Events</h2>
    <div id="click-events"></div>
    
    <h2>Campaign Analytics</h2>
    <div id="analytics"></div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'http://127.0.0.1:54321';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU';
        const client = createClient(supabaseUrl, supabaseKey);

        async function debugLinkTracking() {
            const statusEl = document.getElementById('status');
            const linksEl = document.getElementById('test-links');
            const eventsEl = document.getElementById('click-events');
            const analyticsEl = document.getElementById('analytics');
            
            try {
                // 1. Check for recent sent events
                statusEl.innerHTML = '<p>Checking for sent events...</p>';
                const { data: sentEvents, error: sentError } = await client
                    .from('email_events')
                    .select('*')
                    .eq('event_type', 'sent')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (sentError) {
                    statusEl.innerHTML += `<p style="color: red;">Error fetching sent events: ${sentError.message}</p>`;
                    
                    // Try to check table columns
                    const { data: tableInfo, error: tableError } = await client
                        .rpc('get_table_columns', { table_name: 'email_events' })
                        .single();
                    
                    if (tableInfo) {
                        statusEl.innerHTML += `<p>Table columns: ${JSON.stringify(tableInfo)}</p>`;
                    }
                    return;
                }
                
                statusEl.innerHTML += `<p>Found ${sentEvents?.length || 0} sent events</p>`;
                
                if (sentEvents && sentEvents.length > 0) {
                    // Create test links for each sent event
                    linksEl.innerHTML = '<h3>Click these test links:</h3>';
                    sentEvents.forEach((event, index) => {
                        const trackingId = event.tracking_id || event.id;
                        const testUrl = 'https://example.com/test-page';
                        const trackingUrl = `${supabaseUrl}/functions/v1/link-tracker?id=${trackingId}&url=${encodeURIComponent(testUrl)}`;
                        
                        linksEl.innerHTML += `
                            <div style="margin: 10px 0;">
                                <p>Campaign: ${event.campaign_id}</p>
                                <p>Tracking ID: ${trackingId}</p>
                                <a href="${trackingUrl}" target="_blank" style="color: blue; text-decoration: underline;">
                                    Click to test tracking
                                </a>
                            </div>
                        `;
                    });
                }
                
                // 2. Check for click events
                const { data: clickEvents, error: clickError } = await client
                    .from('email_events')
                    .select('*')
                    .eq('event_type', 'clicked')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (clickError) {
                    eventsEl.innerHTML = `<p style="color: red;">Error fetching click events: ${clickError.message}</p>`;
                } else {
                    eventsEl.innerHTML = `<h3>Click Events (${clickEvents?.length || 0} found):</h3>`;
                    if (clickEvents && clickEvents.length > 0) {
                        clickEvents.forEach(event => {
                            eventsEl.innerHTML += `
                                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                                    <p>Campaign: ${event.campaign_id}</p>
                                    <p>URL: ${event.link_url || event.event_data?.url || 'N/A'}</p>
                                    <p>Time: ${new Date(event.created_at).toLocaleString()}</p>
                                    <p>User Agent: ${event.user_agent || 'N/A'}</p>
                                </div>
                            `;
                        });
                    } else {
                        eventsEl.innerHTML += '<p>No click events found yet. Try clicking the test links above.</p>';
                    }
                }
                
                // 3. Check campaign analytics
                const { data: analytics, error: analyticsError } = await client
                    .from('campaign_analytics')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(5);
                
                if (analyticsError) {
                    analyticsEl.innerHTML = `<p style="color: red;">Error fetching analytics: ${analyticsError.message}</p>`;
                } else {
                    analyticsEl.innerHTML = `<h3>Campaign Analytics:</h3>`;
                    if (analytics && analytics.length > 0) {
                        analytics.forEach(stat => {
                            analyticsEl.innerHTML += `
                                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                                    <p>Campaign ID: ${stat.campaign_id}</p>
                                    <p>Sent: ${stat.sent_count}, Opened: ${stat.opened_count}, Clicked: ${stat.clicked_count}</p>
                                    <p>Click Rate: ${stat.click_rate || 0}%</p>
                                    <p>Updated: ${new Date(stat.updated_at).toLocaleString()}</p>
                                </div>
                            `;
                        });
                    } else {
                        analyticsEl.innerHTML += '<p>No campaign analytics found.</p>';
                    }
                }
                
                // Auto-refresh every 5 seconds
                setTimeout(debugLinkTracking, 5000);
                
            } catch (error) {
                statusEl.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Start debugging
        debugLinkTracking();
    </script>
</body>
</html>