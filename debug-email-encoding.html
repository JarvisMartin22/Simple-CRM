<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Encoding Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .error { background: #fee; border-left: 4px solid #f00; }
        .success { background: #efe; border-left: 4px solid #0a0; }
        .code { background: #f8f9fa; padding: 10px; font-family: monospace; overflow-x: auto; margin: 10px 0; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üìß Email Encoding Issue Debug</h1>

    <div class="section error">
        <h2>‚ùå Problem: Your Email Has Encoding Issues</h2>
        <p><strong>What's happening:</strong> The email content is being quoted-printable encoded, which is breaking the tracking URLs.</p>
        
        <h3>Your Current (Broken) Tracking Pixel:</h3>
        <div class="code">
https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/email-tracker?id<span style="color: red">=3D</span>3b8bb88f-9a3c-460f-92b0-799343254c6b<span style="color: red">&amp;</span>campaign<span style="color: red">=3D</span>00af16fa-f185-4e04-8423-7c1d30f3dfa2<span style="color: red">&amp;</span>contact<span style="color: red">=3D</span>34aa1b48-e5ac-409f-9d26-ae72be1bdf4b
        </div>
        
        <p>Issues:</p>
        <ul>
            <li><code>=3D</code> should be <code>=</code></li>
            <li><code>&amp;</code> should be <code>&</code></li>
            <li>The image tag has spaces breaking it</li>
        </ul>
    </div>

    <div class="section success">
        <h2>‚úÖ Solution: Proper Email Template Format</h2>
        
        <h3>Correct Tracking Pixel (what it should be):</h3>
        <div class="code">
&lt;img src="https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/email-tracker?id=3b8bb88f-9a3c-460f-92b0-799343254c6b&campaign=00af16fa-f185-4e04-8423-7c1d30f3dfa2&contact=34aa1b48-e5ac-409f-9d26-ae72be1bdf4b" width="1" height="1" style="display: none;"&gt;
        </div>

        <h3>Correct Tracked Link Format:</h3>
        <div class="code">
&lt;a href="https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/link-tracker?id=LINK_ID&url=https://www.jarvismartinstack.com" target="_blank"&gt;links&lt;/a&gt;
        </div>
    </div>

    <div class="section">
        <h2>üß™ Test the URLs</h2>
        
        <h3>Test Your Broken URL:</h3>
        <button onclick="testBrokenUrl()">Test Broken Tracking URL</button>
        <div id="brokenResult"></div>
        
        <h3>Test Fixed URL:</h3>
        <button onclick="testFixedUrl()">Test Fixed Tracking URL</button>
        <div id="fixedResult"></div>
        
        <h3>Test Direct Tracking:</h3>
        <button onclick="testDirectTracking()">Test New Tracking Pixel</button>
        <div id="directResult"></div>
    </div>

    <div class="section">
        <h2>üîç Campaign & Contact IDs from Your Email</h2>
        <ul>
            <li><strong>Tracking ID:</strong> 3b8bb88f-9a3c-460f-92b0-799343254c6b</li>
            <li><strong>Campaign ID:</strong> 00af16fa-f185-4e04-8423-7c1d30f3dfa2</li>
            <li><strong>Contact ID:</strong> 34aa1b48-e5ac-409f-9d26-ae72be1bdf4b</li>
        </ul>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è How to Fix This</h2>
        
        <h3>1. Email Template Issues:</h3>
        <ul>
            <li>The email content is being quoted-printable encoded</li>
            <li>This suggests an issue with how the email is being sent</li>
            <li>Check your email sending service configuration</li>
        </ul>
        
        <h3>2. Missing Link Tracking:</h3>
        <p>Your link to jarvismartinstack.com is NOT tracked. It should be:</p>
        <div class="code">
&lt;a href="https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/link-tracker?id=UNIQUE_LINK_ID&url=https://www.jarvismartinstack.com"&gt;links&lt;/a&gt;
        </div>
        
        <h3>3. Check Email Sending Code:</h3>
        <p>Look for where emails are being sent and ensure:</p>
        <ul>
            <li>HTML content is not being double-encoded</li>
            <li>The email service is configured for HTML emails</li>
            <li>Tracking pixels are being inserted correctly</li>
        </ul>
    </div>

    <div class="section">
        <h2>üìä Test Live Campaign Analytics</h2>
        <button onclick="refreshAnalytics()">Refresh Campaign Analytics</button>
        <div id="analyticsResult"></div>
    </div>

    <script>
        const brokenUrl = 'https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/email-tracker?id=3D3b8bb88f-9a3c-460f-92b0-799343254c6b&amp;campaign=3D00af16fa-f185-4e04-8423-7c1d30f3dfa2&amp;contact=3D34aa1b48-e5ac-409f-9d26-ae72be1bdf4b';
        const fixedUrl = 'https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/email-tracker?id=3b8bb88f-9a3c-460f-92b0-799343254c6b&campaign=00af16fa-f185-4e04-8423-7c1d30f3dfa2&contact=34aa1b48-e5ac-409f-9d26-ae72be1bdf4b';

        async function testBrokenUrl() {
            const resultDiv = document.getElementById('brokenResult');
            resultDiv.innerHTML = '<p>Testing broken URL...</p>';
            
            try {
                const response = await fetch(brokenUrl);
                resultDiv.innerHTML = `
                    <div class="result error">
                        Status: ${response.status}<br>
                        This URL is malformed due to encoding issues
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        Error: ${error.message}<br>
                        The broken URL cannot be fetched
                    </div>
                `;
            }
        }

        async function testFixedUrl() {
            const resultDiv = document.getElementById('fixedResult');
            resultDiv.innerHTML = '<p>Testing fixed URL...</p>';
            
            try {
                const response = await fetch(fixedUrl);
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Fixed URL works! Status: ${response.status}<br>
                            Content-Type: ${response.headers.get('content-type')}<br>
                            This should trigger an email open event
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            Status: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        async function testDirectTracking() {
            const resultDiv = document.getElementById('directResult');
            const newTrackingId = `direct-test-${Date.now()}`;
            const directUrl = `https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/email-tracker?id=${newTrackingId}`;
            
            resultDiv.innerHTML = '<p>Testing new tracking pixel...</p>';
            
            try {
                const response = await fetch(directUrl);
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Tracking system working! Status: ${response.status}<br>
                            New tracking ID: ${newTrackingId}<br>
                            The infrastructure is fine - the issue is email encoding
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        async function refreshAnalytics() {
            const resultDiv = document.getElementById('analyticsResult');
            resultDiv.innerHTML = '<p>Refreshing analytics...</p>';
            
            try {
                const response = await fetch('https://bujaaqjxrvntcneoarkj.supabase.co/functions/v1/refresh-campaign-analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaign_id: '00af16fa-f185-4e04-8423-7c1d30f3dfa2'
                    })
                });
                
                if (response.status === 401) {
                    resultDiv.innerHTML = `
                        <div class="result">
                            ‚ö†Ô∏è Analytics requires auth (normal behavior)<br>
                            Campaign ID: 00af16fa-f185-4e04-8423-7c1d30f3dfa2
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        Error: ${error.message}
                    </div>
                `;
            }
        }

        // Test the fixed URL automatically
        window.onload = function() {
            console.log('Testing tracking URLs...');
            console.log('Broken URL:', brokenUrl);
            console.log('Fixed URL:', fixedUrl);
            
            // Create an image to trigger the tracking pixel
            const img = new Image();
            img.src = fixedUrl;
            img.onload = () => console.log('‚úÖ Fixed tracking pixel loaded');
            img.onerror = () => console.log('‚ùå Fixed tracking pixel failed');
        };
    </script>
</body>
</html>